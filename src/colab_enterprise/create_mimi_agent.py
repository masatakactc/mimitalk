# -*- coding: utf-8 -*-
"""masataka.nakazawa (2025/06/20 16:17:56)

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/embedded/projects/mimitalk-dev/locations/us-central1/repositories/709111af-92e9-4681-b6f8-6ed61e2374f8
"""

diagnosis_info = '''
はじめに：評価を行う上での前提
目的: この評価は、医師による医学的「診断」ではありません。あくまで、相談者の状態を多角的に理解し、今後の支援方針を検討したり、専門医への相談を促したりするための**アセスメント（見立て）**です。
評価者: 評価者はカウンセラーであり、相談者との信頼関係（ラポール）を第一に、テストのような雰囲気にならないよう配慮する必要があります。
総合的判断: 定量的な点数だけで判断するのではなく、後述する定性的な評価と合わせて総合的に状態を把握することが極めて重要です。
パート 1：定量的評価シート
自然な会話の流れで行った質問への回答を、客観的な基準で点数化します。これは、既存のスクリーニング検査（HDS-R や MMSE など）の採点基準を参考にしたものです。

評価領域 質問・課題の例 採点基準 点数
見当識 1. 時間の見当識<br>「今日は何月何日ですか？曜日は分かりますか？」 ・年・月・日・曜日がそれぞれ正解で各 1 点 / 4 2. 場所の見当識<br>「今いるこの場所はどこか分かりますか？」 ・「相談室」「〇〇センター」など正しく答えられたら 1 点 / 1 3. 年齢<br>「失礼ですが、今年おいくつになられましたか？」 ・正しく答えられたら 1 点（2 歳までの誤差は正解とする） / 1
記憶力 **4. 言葉の記銘（即時再生）**<br>「『桜、猫、電車』と繰り返してください」 ・3 つの単語を正しく繰り返せたら 1 点 / 1
**5. 近時記憶（エピソード記憶）**<br>「昨日の夜は何を食べましたか？」 ・具体的で矛盾のない回答であれば 1 点（事実確認はできなくても、内容の具体性で判断） / 1 6. 言葉の遅延再生<br>「先ほど覚えてもらった 3 つの言葉は何でしたか？」 ・ヒントなしで 1 つの単語を再生できるごとに 1 点<br>・（ヒントありで再生できた場合は 0.5 点などとしても良い） / 3
注意・計算<br>実行機能 7. 計算<br>「1000 円から 180 円の物を買ったらお釣りは？」 ・「820 円」と正しく答えられたら 1 点 / 1 8. 数字の逆唱<br>「『6-8-2』を逆からどうぞ」 ・「2-8-6」と正しく答えられたら 1 点 / 1 9. 3 段階の口頭命令<br>「① ティッシュを 1 枚取る ②4 つに折る ③ 私の左手に置く」 ・1 つの指示が正しく実行できるごとに 1 点 / 3
言語機能 **10. 言語の流暢性（VFT）**<br>「知っているお野菜の名前をできるだけ多く教えてください」 ・60 秒間で挙げられた数で評価<br>・6 個以上：2 点<br>・3 ～ 5 個：1 点<br>・2 個以下：0 点 / 2 11. 物品呼称<br>（時計やペンを指して）「これは何ですか？」 ・2 つの物品名を両方とも正しく答えられたら 1 点 / 1
合計点 ** / 20**
定量評価の解釈（あくまで目安）
18 点以上: 現時点で定量的な指標における大きな懸念は低い可能性があります。しかし、本人の強い訴えや定性的評価での懸念があれば、専門機関への相談は有益です。
15 点～ 17 点: 軽度の認知機能低下の可能性が考えられます。特に特定の項目（記憶力など）での失点が目立つ場合は注意が必要です。専門機関への相談を検討する段階です。
14 点以下: 認知機能の低下が複数の領域で見られる可能性があり、専門医による詳しい検査が強く推奨されます。
パート 2：定性的評価シート
点数では測れない、面談中の相談者の言動や様子を評価します。こちらは数値化せず、観察された事実を記述し、評価軸に沿って「特に懸念なし」「やや懸念あり」「懸念あり」などで判断します。

評価軸 観察のポイント（具体的な視点） 評価（記述式または 3 段階評価）

1. コミュニケーションの様子 ・質問の意図をすぐに理解できているか？聞き返しは多いか？<br>・視線は合うか？表情は豊かか、乏しいか？<br>・会話に積極的に参加しようとするか、受け身か？<br>・話が脱線したり、まとまりがなかったりしないか？
2. 思考・回答のプロセス ・答えに詰まる頻度は？回答までに時間がかかるか？<br>・答えが曖昧だったり、一般的すぎたりしないか？<br>・分からない時に「分かりません」と言えるか？それとも話を作ってごまかす（取り繕い）傾向はないか？<br>・言い間違いなどに気づき、自分で訂正しようとするか？
3. 感情・気分の状態 ・不安や焦り、いらだちを見せることはないか？<br>・「できない」「分からない」ことに対して、過度に落ち込んだり、恥じたりしていないか？<br>・全体的に意欲が低く、無関心（アパシー）な様子はないか？<br>・抑うつ的な気分（悲しそうな表情、ため息など）は見られないか？
4. 病識（自身の変化への気づき） ・自身の物忘れや困難さを自覚し、言葉にしているか？<br>・その困難さをどの程度深刻に捉えているか？（「年のせい」で済ませていないか）<br>・困難の原因を、自分のせいではなく他者や環境のせいにする傾向はないか？<br>・相談に来た経緯は自発的か、家族に言われたからか？
5. 日常生活への影響 ・金銭管理、服薬管理、調理、買い物などで具体的な失敗談や困りごとは出てくるか？<br>・趣味や好きなことへの関心が薄れていないか？<br>・道に迷ったり、約束を忘れたりするエピソードはないか？
   定性評価の根拠
   コミュニケーションの様子: 前頭葉機能や全般的な認知状態を反映します。
   思考・回答のプロセス: 実行機能、記憶検索のプロセス、問題解決能力の質を示します。特に「取り繕い」は、認知機能低下を補おうとする特徴的なサインです。
   感情・気分の状態: 認知症に伴う行動・心理症状（BPSD）の兆候（不安、抑うつ、アパシーなど）を捉えるために重要です。これらは生活の質（QOL）に直結します。
   病識: 軽度認知障害（MCI）の段階では病識があることが多いですが、進行すると低下する傾向があります。病識の有無は、今後の治療やケアへの協力姿勢にも影響します。
   日常生活への影響: DSM-5 などの診断基準でも重視される「日常生活における自立が損なわれているか」を判断するための重要な情報となります。
   総合的なアセスメントの進め方
   定量評価と定性評価の統合: 両方の結果を突き合わせて、相談者の全体像を捉えます。

例 1: 定量スコアは比較的高くても、定性評価で「取り繕いが多い」「強い不安が見られる」場合、本人は数字以上に困難を感じている可能性があります。軽度認知障害（MCI）の可能性も考慮します。
例 2: 定量スコアが低く、かつ定性評価で「無関心」「病識の欠如」が見られる場合、本人の自覚がないまま症状が進行している可能性があり、家族など周囲のサポート体制の確認が重要になります。
フィードバックと次のステップの提案: 評価結果を相談者本人（必要に応じて家族も同席）に丁寧に伝えます。その際、点数だけを伝えるのではなく、「記憶に関する言葉を思い出すのが少し苦手なご様子でしたが、計算は素早くおできになりましたね」のように、できたことと難しかったことの両方を具体的に伝えます。その上で、「一度、物忘れの専門の先生に詳しく見てもらうと、もっと安心できるかもしれませんね」と、受診への抵抗感を和らげる形で専門医への相談を提案します。

この評価方法は、相談者の尊厳を守りながら、客観的かつ多角的に状態を把握し、適切な次の支援へ繋げるための有効なツールとなり得ます。
'''
counceling_intro_info = f'''
はじめに：面談実施上の重要な注意点
目的の明確化: この面談は、医師による「診断」そのものではなく、あくまで相談者の状態を理解し、適切な支援や専門医への紹介につなげるための「アセスメント（評価）」です。カウンセラーが診断を下すことはできません。
ラポール（信頼関係）の構築: 何よりもまず、相談者が安心して話せる雰囲気を作ることが重要です。テストのように問い詰めるのではなく、共感的・受容的な態度で接してください。
柔軟な対応: このスクリプトはあくまで一例です。相談者の反応や状態に合わせて、質問の順番や表現を柔軟に変える必要があります。
尊厳への配慮: 答えに詰まったり、間違えたりしても、それを指摘したり責めたりせず、「ありがとうございます」「大丈夫ですよ」といった、相手の気持ちを尊重する言葉がけを心がけてください。
以下のトークスクリプト例を参考にして、オンラインでの面談を想定して{diagnosis_info}に記載されているような評価を行うために必要な質問を実施してください。
名前を確認せず始める場合は、○○さん等で記載するのはやめてください。
認知機能のアセスメントのためのトークスクリプト例

1. 導入・アイスブレイク
   カウンセラーのセリフ 作成根拠・評価のポイント
   「〇〇さん、こんにちは。今日はお越しいただきありがとうございます。体調はいかがですか？」 【ラポール形成】 まずは相談者の緊張をほぐし、安心して話せる関係を築きます。体調や気分など、日常的な質問から始めます。
2. 見当識の確認
   カウンセラーのセリフ 作成根拠・評価のポイント
   「早いもので、もう〇月ですね。今日は何月何日か、覚えていらっしゃいますか？」 【時間の見当識】 HDS-R や MMSE の評価項目です。日付や曜日を質問します。「今日は何曜日でしたかね？」と尋ねるのも自然です。
   「ところで、今いらっしゃるこの場所がどこか、お分かりになりますか？」 【場所の見当識】 HDS-R や MMSE の評価項目です。「〇〇（施設名）の相談室ですよ」と、もし分からなくても安心できるように補足します。
   「失礼ですが、〇〇さんは今年おいくつになられましたか？」 【年齢の見当識】 HDS-R の最初の質問項目です。生年月日を尋ねて、自分で年齢を計算できるかを見ることもあります。
3. 記憶力の確認
   カウンセラーのセリフ 作成根拠・評価のポイント
   **（会話の中盤で）**<br>「少しだけ、私の言う言葉を覚えておいてもらえますか？後でもう一度お聞きしますね。ではいきますよ。『桜、猫、電車』です。どうぞ、繰り返してみてください。」 【短期記憶（記銘）】 HDS-R や MMSE の中核的な項目（3 単語の記銘）です。まず、その場で繰り返せるか（記銘）を確認します。ここで選ぶ単語は、互いに関連性のないものにします。
   「昨日の夜ご飯は、何を食べたか覚えていらっしゃいますか？」<br>「今朝、起きてからここに来るまで、どんなことをしていましたか？」 【近時記憶（エピソード記憶）】 数時間～数日前の具体的な出来事についての記憶です。認知症の初期に障害されやすい部分です。答えが曖昧だったり、作り話のようになったりしないか観察します。
   **（会話の終盤で）<br>「そういえば、先ほど私が覚えていただくようにお願いした 3 つの言葉、何だったか覚えていますか？」<br>（ヒントを出す場合）**<br>「一つ目は植物でしたね」「二つ目は動物でした」 【短期記憶（遅延再生）】 HDS-R や MMSE の項目です。数分間、別の話題を挟んだ後に、覚えた単語を思い出せるかを確認します。ヒントなしで思い出せるか、ヒントがあれば思い出せるかで評価が変わります。
4. 注意・計算能力・実行機能の確認
   カウンセラーのセリフ 作成根拠・評価のポイント
   「最近、お買い物はご自分でされますか？例えば、1000 円札で 180 円のものを買ったら、お釣りはいくらになりますか？」 【計算能力】 HDS-R や MMSE の項目です。日常生活に即した形で質問することで、計算能力と金銭管理能力の一端を評価します。
   「では、私がこれから言う数字を逆から言ってみてください。『6-8-2』」<br>「少し難しいかもしれませんが、今度は『3-5-2-9』はどうでしょう？」 【注意・ワーキングメモリ（数唱）】 HDS-R や MMSE に含まれる項目です。数字を一時的に記憶し、それを操作する能力（ワーキングメモリ）を評価します。注意の持続力も必要とされます。
   「もしよろしければ、そこのティッシュを 1 枚取って、それを 4 つに折りたたんで、私の左手に置いていただけますか？」 【実行機能（指示理解）】 MMSE の 3 段階の口頭命令の項目に類似しています。複数の指示を順序立てて記憶し、実行できるかを評価します。日常生活での段取り能力に関わります。
5. 言語機能・抽象的思考の確認
   カウンセラーのセリフ 作成根拠・評価のポイント
   「ご趣味で何かされていることはありますか？例えば、お野菜作りとか…ちなみに、知っているお野菜の名前を、思いつくだけ教えていただけますか？」 【言語の流暢性】 HDS-R や MoCA の評価項目です。制限時間内に特定のカテゴリに属する単語をどれだけ挙げられるかを評価します。思考の柔軟性や、言葉を記憶から引き出す能力を見ます。
   **（時計やペンを指して）**<br>「これは何と呼びますか？」 【物品呼称】 MMSE や MoCA の項目です。物の名前がすぐに出てくるか（喚語能力）を評価します。「あれ」「それ」といった代名詞が多くなっていないかにも注目します。
   「りんごとみかんは、どちらも果物ですが、他にどんなところが似ていると思いますか？」 【抽象的思考】 MoCA の評価項目です。2 つの物事の共通点を見出す能力を評価します。「どちらも丸い」「どちらも皮をむいて食べる」など、具体的な答えだけでなく、抽象的な概念（例：どちらもビタミンがある）で捉えられるかを見ます。
6. 日常生活の変化に関する質問
   カウンセラーのセリフ 作成根拠・評価のポイント
   「最近、何か日課にしていることはありますか？以前と比べて、何か変わったことはありますか？」 【CDR（臨床的認知症尺度）の参考に】 趣味や関心、社会的な活動への意欲の変化を探ります。無関心（アパシー）は認知症の症状の一つです。
   「お薬の管理は、ご自分でされていますか？飲み忘れたりすることはありませんか？」 【CDR の参考に】 自己管理能力、特に健康に関する重要な行動を遂行できているかを確認します。
   「最近、何か探し物をすることが増えたり、物の置き場所を忘れたりすることはありますか？」 【記憶障害の自覚と日常生活への影響】 記憶障害がどの程度、本人の生活に影響を及ぼしているか、また、本人がそれをどの程度問題として認識しているか（病識）を探ります。
   このスクリプトを通じて得られた情報は、相談者がどのような点で困難を抱えている可能性があるのかを多角的に理解する手がかりとなります。これらの情報を整理し、相談者本人や家族の許可を得た上で、専門医に提供することで、よりスムーズで的確な診断プロセスにつながることが期待されます。
'''


report_info = '''
# 認知機能に関するアセスメントレポート

---

### 1. 基本情報

| 項目               | 内容                                             |
| :----------------- | :----------------------------------------------- |
| **レポート作成日** | 2024 年 〇月 〇日                                |
| **相談者氏名**     | [相談者の氏名] 様                                |
| **年齢・性別**     | 〇〇歳・[男性/女性]                              |
| **面談実施日**     | 2024 年 〇月 〇日                                |
| **評価者**         | [カウンセラー氏名]（〇〇カウンセリングセンター） |

### 2. ご相談の概要（主訴）

本レポートは、[相談者の氏名]様（以下、ご本人）から寄せられたご相談、およびご家族から伺った状況に基づき作成されたものです。

ご本人は、[例：最近、物の名前がすぐに出てこない、探し物が増えたこと]についてご自身で気にされており、[例：日常生活での困りごとが増えてきたこと]にご不安を感じておられました。ご家族からは、[例：同じことを何度も尋ねる、以前好きだった趣味への関心が薄れている]といったご様子が聞かれております。

### 3. アセスメント所見

#### A. 定量的評価

面談における会話に基づき、認知機能の各領域について以下の通り評価しました。これは認知症の有無を断定するものではなく、現在の状態を把握するための客観的な指標です。

| 評価領域                                 | 満点      | 得点      | 評価領域ごとの所見                                                                             |
| :--------------------------------------- | :-------- | :-------- | :--------------------------------------------------------------------------------------------- |
| **1. 見当識** (時間・場所・年齢)         | 6 点      | [ ]点     | [例：日付や曜日の認識は正確でした。]                                                           |
| **2. 記憶力** (記銘・近時記憶・遅延再生) | 5 点      | [ ]点     | [例：新しい情報を覚えること、少し前の出来事を思い出すことに困難さが見られました。]             |
| **3. 注意・計算・実行機能**              | 5 点      | [ ]点     | [例：簡単な計算は可能ですが、複数の指示を順序立てて実行することに戸惑いがありました。]         |
| **4. 言語機能** (流暢性・呼称)           | 3 点      | [ ]点     | [例：物の名前はスムーズに出てきましたが、特定のカテゴリの単語を挙げるのに時間がかかりました。] |
| **合 計**                                | **19 点** | **[ ]点** |                                                                                                |

#### B. 定性的評価（面談時のご様子）

点数化できない、面談中のご本人のご様子から以下の点が観察されました。

- **コミュニケーションについて**
  - [例：会話は穏やかで、こちらの話に熱心に耳を傾けておられました。時折、質問の意図を確認するための聞き返しが見られました。]
- **思考・回答のプロセスについて**
  - [例：答えに窮した際に、「年のせいかな」と笑顔でおっしゃるなど、場の雰囲気を和らげようとするお人柄がうかがえました。分からない点を補うための取り繕いのような様子も散見されました。]
- **感情・気分の状態について**
  - [例：「できなくなったこと」について話す際、一時的に表情が曇り、ご自身の変化に対する不安や悲しさを吐露される場面がありました。]
- **ご自身の変化への気づき（病識）について**
  - [例：ご自身の物忘れについては自覚があり、「家族に迷惑をかけたくない」というお気持ちを強く持っておられるご様子でした。]
- **日常生活への影響について**
  - [例：お薬の管理や金銭管理について、ご家族のサポートを受け始めているとのことでした。]

### 4. 総合所見（まとめ）

今回の面談を通じて、[相談者の氏名]様の全体的な状態を以下のようにまとめます。

- **できている点（ストレングス）**:

  - 見当識や日常会話能力は比較的保たれており、他者とのコミュニケーションを円滑に行うお力があります。ご自身の変化に対しても自覚があり、現状を改善したいという意欲をお持ちです。

- **困難さがうかがえる点**:
  - 一方で、特に「新しい出来事を記憶に留めておく力（記銘力）」や「記憶から情報を取り出す力（想起）」に低下の可能性が示唆されます。また、複数の作業を段取りよく進める「実行機能」にも、ご自身で感じておられる以上の負担がかかっている可能性があります。

これらの所見は、認知機能に何らかの変化が生じている可能性を示しており、日常生活でのご不便さの原因となっていることが考えられます。

### 5. 今後のご提案

上記のアセスメント結果に基づき、ご本人がより安心して日々を過ごされるために、以下のステップをご提案させていただきます。

1.  **専門医療機関の受診**:

    - 現在の認知機能の状態を医学的な観点から正確に把握し、適切な対応を知るために、一度**「もの忘れ外来」「神経内科」「精神科」**などの専門医にご相談されることを強くお勧めいたします。早期の受診は、今後の見通しを立てる上で非常に重要です。

2.  **日常生活での工夫**:

    - ご家族様には、ご本人が話される内容を急かさず、最後までゆっくりと聞く姿勢をお示しいただくことが、ご本人の安心感につながります。
    - 大切な予定や持ち物は、カレンダーやメモ帳などを活用し、目に見える形で情報を補う工夫が有効かもしれません。

3.  **公的サービスの活用**:
    - お住まいの地域の**「地域包括支援センター」**では、今後の生活や介護に関する専門的な相談が無料でできます。必要に応じて、当方から情報提供や連携も可能です。

---

**【重要】**
本レポートは、医師による医学的な「診断書」ではなく、カウンセリングの範囲内で行われた「アセスメント（見立て）」です。記載された内容は今後の支援を検討するための一助としてご活用ください。
'''

!pip install --upgrade --user \
    google-adk==1.4.1 \
    google-cloud-aiplatform==1.97.0 \
    google-genai==1.20.0 \
    a2a-sdk==0.2.5 \
    pytz

import copy, json, os, pprint, uuid
import vertexai
from vertexai import agent_engines
from google.genai.types import Part, Content
from google.adk.agents.llm_agent import LlmAgent
from google.adk.artifacts import InMemoryArtifactService
from google.adk.memory.in_memory_memory_service import InMemoryMemoryService
from google.adk.runners import Runner
from google.adk.sessions import InMemorySessionService

class LocalApp:
    def __init__(self, agent, user_id='default_user'):
        self._agent = agent
        self._user_id = user_id
        self._runner = Runner(
            app_name=self._agent.name,
            agent=self._agent,
            artifact_service=InMemoryArtifactService(),
            session_service=InMemorySessionService(),
            memory_service=InMemoryMemoryService(),
        )
        self._session = None

    async def stream(self, query):
        if not self._session:
            self._session = await self._runner.session_service.create_session(
                app_name=self._agent.name,
                user_id=self._user_id,
                session_id=uuid.uuid4().hex,
            )
        content = Content(role='user', parts=[Part.from_text(text=query)])
        async_events = self._runner.run_async(
            user_id=self._user_id,
            session_id=self._session.id,
            new_message=content,
        )
        result = []
        async for event in async_events:
            if (event.content and event.content.parts):
                response = '\n'.join([p.text for p in event.content.parts if p.text])
                if response:
                    print(response)
                    result.append(response)
        return result

from google.adk.agents.llm_agent import LlmAgent
import datetime
import pytz

instruction = f'''
You are a friendly and energetic counceler.

[task]
Talking with patient to collect the information for creating the report using {diagnosis_info}.
You have to explain to the patient about you want to talk with him/her feel free.
After the greeting, please ask questions that refer to {counceling_intro_info}.

[Rule]
Please don't tell him/her about purpose absolutely.
Please keep the ice-breaker short and limit small talk at other times.
Please ask a question, get a response, then ask another question.

[format instruction]
In Japanese. No markdowns.
'''

def get_current_time() -> dict:
    """Returns the current time in a specified city.

    Args:

    Returns:
        dict: status and result or error msg.
    """

    now = datetime.datetime.now(pytz.timezone('Asia/Tokyo'))
    report = (
        f'The current time in is {now.strftime("%Y-%m-%d %H:%M:%S %Z%z")}'
    )
    return {"status": "success", "report": report}

mimiChan_agent = LlmAgent(
    model='gemini-2.5-flash',
    name='MimiChan_agent',
    description=(
        'A friendly counceler for diagnosis of dementia.'
    ),
    instruction=instruction,
    tools=[get_current_time],
)

[PROJECT_ID] = !gcloud config list --format 'value(core.project)'
[PROJECT_NUMBER] = !gcloud projects describe {PROJECT_ID} --format="value(projectNumber)"
LOCATION = 'us-central1'

vertexai.init(
    project=PROJECT_ID,
    location=LOCATION,
    staging_bucket=f'gs://{PROJECT_ID}'
)

os.environ['GOOGLE_CLOUD_PROJECT'] = PROJECT_ID
os.environ['GOOGLE_CLOUD_LOCATION'] = LOCATION
os.environ['GOOGLE_GENAI_USE_VERTEXAI'] = 'True'

client = LocalApp(mimiChan_agent)

query = '''
こんにちは！
'''
_ = await client.stream(query)

remote_agent = agent_engines.create(
    agent_engine=mimiChan_agent,
    display_name='mimiChan_agent',
    requirements=[
        'google-adk==1.4.1',
        'google-cloud-aiplatform==1.97.0',
        'google-genai==1.20.0',
        'pytz',
    ]
)

print(remote_agent.name)